services:
  app:
    build:
      context: ./testapi
    command: bash -c "sleep 10 && bundle exec rails db:create db:migrate db:seed && rails server -p 3040 -b 0.0.0.0"
    image: myapp:latest
    container_name: rails_app
    expose:
      - "3040" # Rails app listens on port 3040
    networks:
      - app_network
    volumes:
      - ./certs/newcerts:/certs
    depends_on:
      - db

  nginx:
    image: nginx:latest@sha256:fb01117203ff38c2f9af91db1a7409459182a37c87cced5cb442d1d8fcc66d19
    container_name: nginx_server
    ports:
      - "443:443" # Expose TLS port
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/cert.pem:/etc/nginx/cert.pem:ro
      - ./nginx/key.pem:/etc/nginx/key.pem:ro
    depends_on:
      - app
    networks:
      - app_network

  db:
    image: mysql:8.4.6@sha256:869218921e61d6c3c89820955d63cca42971f0e3e6c1e2792247bbd944ebc6e9
    command:
      - --ssl-ca=/etc/mysql/certs/ca.pem
      - --ssl-cert=/etc/mysql/certs/server-cert.pem
      - --ssl-key=/etc/mysql/certs/server-key.pem
      - --bind-address=0.0.0.0    
    container_name: mysql_db
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: my_database
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    volumes:
      - db_data:/var/lib/mysql
      - ./certs/newcerts:/etc/mysql/certs
    networks:
      - app_network

volumes:
  db_data:

networks:
  app_network: